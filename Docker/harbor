Harbor 安装部署

Docker 安装
yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
yum install docker-ce
curl -fsSL get.docker.com -o get-docker.sh
sudo sh get-docker.sh --mirror Aliyun

Docker-Compose 安装
sudo curl -L https://github.com/docker/compose/releases/download/1.19.0/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose # 下载
sudo chmod +x /usr/local/bin/docker-compose # 赋予执行权限
docker-compose --version # 查看版本
https://docs.docker.com/compose/install/#install-compose # 官网文档地址

Harbor 包下载
https://github.com/vmware/harbor/releases/  - Harbor offline installer # 包下载地址

修改配置harbor.cfg
hostname = 10.25.1.212 # 修改本机ip地址或域名 拒绝设置127.0.0.1

错误处理：
docker login ip 登录时 出现拒绝链接
错误信息：Error response from daemon: Get https://10.236.63.76/v1/users/: dial tcp 10.236.63.76:443: getsockopt: connection refused
这是因为docker1.3.2版本开始默认docker registry使用的是https，我们设置Harbor默认http方式，所以当执行用docker login、pull、push等命令操作非https的docker regsitry的时就会报错。解决办法：
修改配置/etc/sysconfig/docker，将OPTIONS增加–insecure-registry ip” # IP 是 该服务器的ip地址


jenkins 构建docker镜像
插件：CloudBees Docker Build and Publish plugin

Docker设置阿里云仓库
https://link.zhihu.com/?target=https%3A//cr.console.aliyun.com/%23/accelerator
sudo mkdir -p /etc/docker sudo tee /etc/docker/daemon.json <<-'EOF' { "registry-mirrors": ["https://0x37tqe1.mirror.aliyuncs.com"] } EOF sudo systemctl daemon-reload sudo systemctl restart docker

 /etc/sysconfig/docker 添加 OPTIONS="--insecure-registry 10.25.1.212" # 私有仓库

/usr/lib/systemd/system/docker.service 设置如下：

[Unit]
Description=Docker Application Container Engine
Documentation=http://docs.docker.com
After=network.target
Wants=docker-storage-setup.service
Requires=docker-cleanup.timer

[Service]
Type=notify
ExecStart=/usr/bin/docker-current daemon --tls=false -H unix:///var/run/docker.sock  -H tcp://10.25.1.136:2375  \
          --add-runtime docker-runc=/usr/libexec/docker/docker-runc-current \
          --default-runtime=docker-runc \
          --exec-opt native.cgroupdriver=systemd \
          --userland-proxy-path=/usr/libexec/docker/docker-proxy-current \
          --insecure-registry 10.25.1.212 \
          $OPTIONS \
          $DOCKER_STORAGE_OPTIONS \
          $DOCKER_NETWORK_OPTIONS \
          $ADD_REGISTRY \
          $BLOCK_REGISTRY \
          $INSECURE_REGISTRY
ExecReload=/bin/kill -s HUP $MAINPID
LimitNOFILE=infinity
LimitNPROC=infinity
LimitCORE=infinity
TimeoutStartSec=0
Delegate=yes
KillMode=process

[Install]
WantedBy=multi-user.target

错误处理：
日志：Mar  6 16:52:52 localhost docker-current: time="2018-03-06T16:52:52.283233970+08:00" level=error msg="Upload failed, retrying: received unexpected HTTP status: 500 Internal Server Error"
关闭selinux
